version: "3.8"

services:
  # Discord Bot (C#)
  bot:
    build:
      context: .
      dockerfile: apps/frontend/bot/Dockerfile
    container_name: pogo-bot
    environment:
      # Discord Configuration
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}

      # Bot BFF Configuration
      BOT_BFF_URL: http://bot-bff:6001

      # ASP.NET Core Configuration
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:2000
    ports:
      - "2000:2000"
    depends_on:
      bot-bff:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  # Mobile Web App
  app:
    build:
      context: .
      dockerfile: app.Dockerfile
    container_name: pogo-app
    environment:
      # App BFF Configuration
      REACT_APP_API_URL: http://app-bff:6002
    ports:
      - "3000:3000"
    depends_on:
      app-bff:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  # Bot BFF (Backend for Frontend)
  bot-bff:
    build:
      context: .
      dockerfile: apps/backend/bffs/Bot.BFF/Dockerfile
    container_name: bot-bff
    environment:
      - OCRServiceUrl=http://ocr-service:5001
    ports:
      - "6001:6001"
    depends_on:
      account-service:
        condition: service_healthy
      player-service:
        condition: service_healthy
      location-service:
        condition: service_healthy
      gym-service:
        condition: service_healthy
      raid-service:
        condition: service_healthy
      ocr-service:
        condition: service_started
    networks:
      - pogo-network
    restart: unless-stopped

  # App BFF (Backend for Frontend)
  app-bff:
    build:
      context: .
      dockerfile: apps/backend/bffs/App.BFF/Dockerfile
    container_name: app-bff
    ports:
      - "6002:6002"
    depends_on:
      account-service:
        condition: service_healthy
      player-service:
        condition: service_healthy
      location-service:
        condition: service_healthy
      gym-service:
        condition: service_healthy
      raid-service:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  # Swagger Gateway
  swagger-gateway:
    build:
      context: .
      dockerfile: apps/backend/gateways/Swagger.Gateway/Dockerfile
    container_name: swagger-gateway
    ports:
      - "10000:10000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:10000
    depends_on:
      account-service:
        condition: service_healthy
      player-service:
        condition: service_healthy
      location-service:
        condition: service_healthy
      gym-service:
        condition: service_healthy
      raid-service:
        condition: service_healthy
      bot-bff:
        condition: service_healthy
      app-bff:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  # Microservices
  account-service:
    build:
      context: .
      dockerfile: apps/backend/microservices/Account.Service/Dockerfile
    container_name: account-service
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__DefaultConnection=Server=account-db,1433;Database=AccountDb;User Id=sa;Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=true;
    depends_on:
      account-db:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  player-service:
    build:
      context: .
      dockerfile: apps/backend/microservices/Player.Service/Dockerfile
    container_name: player-service
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5002
      - ConnectionStrings__DefaultConnection=Server=player-db,1433;Database=PlayerDb;User Id=sa;Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=true;
    depends_on:
      player-db:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  location-service:
    build:
      context: .
      dockerfile: apps/backend/microservices/Location.Service/Dockerfile
    container_name: location-service
    ports:
      - "5003:5003"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5003
      - ConnectionStrings__DefaultConnection=Server=location-db,1433;Database=LocationDb;User Id=sa;Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=true;
    depends_on:
      location-db:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  gym-service:
    build:
      context: .
      dockerfile: apps/backend/microservices/Gym.Service/Dockerfile
    container_name: gym-service
    ports:
      - "5004:5004"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5004
      - ConnectionStrings__DefaultConnection=Server=gym-db,1433;Database=GymDb;User Id=sa;Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=true;
      - LocationService__BaseUrl=http://location-service:5003
    depends_on:
      gym-db:
        condition: service_healthy
      location-service:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  raid-service:
    build:
      context: .
      dockerfile: apps/backend/microservices/Raid.Service/Dockerfile
    container_name: raid-service
    ports:
      - "5005:5005"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5005
      - ConnectionStrings__DefaultConnection=Server=raid-db,1433;Database=RaidDb;User Id=sa;Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=true;
      - GymService__BaseUrl=http://gym-service:5004
      - PlayerService__BaseUrl=http://player-service:5002
    depends_on:
      raid-db:
        condition: service_healthy
      gym-service:
        condition: service_healthy
      player-service:
        condition: service_healthy
    networks:
      - pogo-network
    restart: unless-stopped

  ocr-service:
    build:
      context: .
      dockerfile: apps/backend/microservices/OCR.Service/Dockerfile
    container_name: ocr-service
    ports:
      - "5006:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
    networks:
      - pogo-network
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - pogo-network
    restart: unless-stopped

  # Microservice Databases
  account-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: account-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1433:1433"
    volumes:
      - account_db_data:/var/opt/mssql
    networks:
      - pogo-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -Q 'SELECT 1'",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  player-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: player-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1434:1433"
    volumes:
      - player_db_data:/var/opt/mssql
    networks:
      - pogo-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -Q 'SELECT 1'",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  location-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: location-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1435:1433"
    volumes:
      - location_db_data:/var/opt/mssql
    networks:
      - pogo-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -Q 'SELECT 1'",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  gym-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: gym-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1436:1433"
    volumes:
      - gym_db_data:/var/opt/mssql
    networks:
      - pogo-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -Q 'SELECT 1'",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  raid-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: raid-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1437:1433"
    volumes:
      - raid_db_data:/var/opt/mssql
    networks:
      - pogo-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -Q 'SELECT 1'",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

volumes:
  account_db_data:
    name: pogo-account-db-data
  player_db_data:
    name: pogo-player-db-data
  location_db_data:
    name: pogo-location-db-data
  gym_db_data:
    name: pogo-gym-db-data
  raid_db_data:
    name: pogo-raid-db-data

networks:
  pogo-network:
    name: pogo-network
    driver: bridge
